name: Build and Release Rust Binary (Manual Trigger)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Git Tag for the Release (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Is this a pre-release?'
        required: false
        type: boolean
        default: false
      draft:
        description: 'Create as a draft release?'
        required: false
        type: boolean
        default: false

jobs:
  build_and_upload_release_asset:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Rust binary in Docker (Alpine Musl)
        run: |
          echo "Starting Docker build for crslabcommentsreptile..."
          docker build -t crslabcommentsreptile-musl-builder -f Dockerfile.release .

          echo "Extracting binary from Docker container..."
          docker create --name temp_crslabcommentsreptile_builder crslabcommentsreptile-musl-builder
          docker cp temp_crslabcommentsreptile_builder:/crslabcommentsreptile_final ./crslabcommentsreptile_linux_musl
          docker rm temp_crslabcommentsreptile_builder

          echo "Binary 'crslabcommentsreptile_linux_musl' successfully extracted."
          ls -l ./crslabcommentsreptile_linux_musl
          file ./crslabcommentsreptile_linux_musl

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          # 使用手动输入的 tag
          tag_name: ${{ github.event.inputs.tag }}
          name: Release ${{ github.event.inputs.tag }} - CRSLab Comments Reptile
          # 使用手动输入的 draft 和 prerelease
          draft: ${{ github.event.inputs.draft }}
          prerelease: ${{ github.event.inputs.prerelease }}
          body: |
            # Release ${{ github.event.inputs.tag }}

            This is a new release of **CRSLab Comments Reptile** for Linux (musl) using a fully static build.

            ## Features/Changes in this release:
            - Built manually via GitHub Actions workflow_dispatch.
            - Includes `opencc` and `openssl` dependencies.
            - Small, statically linked executable for high portability.
            - ... (Add your specific release notes here. You can refer to Git commits between the last release and this tag if desired.)

            ### Download:
            - `crslabcommentsreptile-linux-musl-${{ github.event.inputs.tag }}` (Linux, x86_64, statically linked with musl)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Release Asset
        id: upload_asset
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./crslabcommentsreptile_linux_musl
          asset_name: crslabcommentsreptile-linux-musl-${{ github.event.inputs.tag }}
          asset_content_type: application/octet-stream
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
